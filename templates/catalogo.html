{% extends 'base.html' %}
{% load static %}

{% block title %}Catálogo | Aura Essence{% endblock %}

{% block content %}
<section class="bg-brand-light dark:bg-zinc-900 py-10 transition-colors duration-300">
    <div class="container mx-auto px-4">
        <h1 class="font-serif text-4xl font-bold text-center mb-4 text-brand-dark dark:text-white">Nuestra Colección
        </h1>
        <p class="text-center text-gray-500 dark:text-gray-400 mb-12 max-w-2xl mx-auto">Explora las fragancias más
            exclusivas, diseñadas para evocar emociones y recuerdos únicos.</p>

        <!-- Filtros -->
        <!-- MARKER: templates/catalogo.html workspace -->
        <div class="flex flex-wrap justify-center gap-4 mb-12">
            <div id="__debug" class="sr-only">DEBUG: first={{ categorias.0.nombre }} count={{ categorias|length }}</div>
            <a href="?categoria=todas"
                class="px-6 py-2 rounded-full {% if not request.GET.categoria or request.GET.categoria == 'todas' %}bg-brand-dark text-white{% else %}bg-white text-gray-600 border border-gray-200{% endif %} text-sm font-bold hover:bg-brand-gold hover:text-white transition-colors">Todos</a>
            {% for cat in categorias %}
            <a href="?categoria={{ cat.id }}"
                class="px-6 py-2 rounded-full {% if request.GET.categoria == cat.id|stringformat:'s' %}bg-brand-dark text-white{% else %}bg-white dark:bg-zinc-800 dark:text-gray-300 dark:border-gray-600 text-gray-600 border border-gray-200{% endif %} text-sm font-bold hover:border-brand-gold hover:text-brand-gold transition-colors">{{
                cat.nombre|default:cat }}</a>
            {% endfor %}
        </div>

        <!-- Grid de Productos -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
            {% for producto in productos %}
            <div
                class="group bg-white dark:bg-zinc-800 dark:border-gray-700 rounded-xl shadow-sm hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 overflow-hidden border border-gray-100 relative">

                <!-- Badge Nuevo/Oferta (Simulado) -->
                {% if forloop.counter|divisibleby:3 %}
                <span
                    class="absolute top-4 left-4 z-10 bg-brand-gold text-white text-[10px] font-bold px-2 py-1 rounded-sm uppercase tracking-wider">Nuevo</span>
                {% endif %}

                <!-- Imagen -->
                <div class="relative h-64 overflow-hidden bg-gray-100 flex items-center justify-center">
                    {% if producto.imagen %}
                    <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}"
                        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                    {% else %}
                    <!-- Placeholder dinámico -->
                    <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                        <i class="fa-solid fa-spray-can-sparkles text-4xl text-gray-400"></i>
                    </div>
                    {% endif %}

                    <!-- Quick Actions Overlay -->
                    <div
                        class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center gap-3">
                        <a href="{% url 'frontend:detalle_producto' producto.id %}"
                            class="bg-white text-brand-dark w-10 h-10 rounded-full flex items-center justify-center hover:bg-brand-gold hover:text-white transition-colors transform translate-y-4 group-hover:translate-y-0 duration-300"
                            title="Ver Detalles">
                            <i class="fa-solid fa-eye"></i>
                        </a>
                        <button
                            class="bg-white text-brand-dark w-10 h-10 rounded-full flex items-center justify-center hover:bg-brand-gold hover:text-white transition-colors transform translate-y-4 group-hover:translate-y-0 duration-300 delay-75 add-to-cart-btn"
                            data-id="{{ producto.id }}" title="Añadir al Carrito">
                            <i class="fa-solid fa-cart-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- Info -->
                <div class="p-6">
                    <div class="text-xs text-brand-gold mb-2 font-bold uppercase tracking-wide">
                        {{ producto.marca.nombre|default:"Aura Essence" }}
                    </div>
                    <a href="{% url 'frontend:detalle_producto' producto.id %}" class="block">
                        <h3 class="font-serif font-bold text-lg mb-2 text-brand-dark dark:text-gray-100 group-hover:text-brand-gold transition-colors cursor-pointer truncate"
                            title="{{ producto.nombre }}">
                            {{ producto.nombre }}
                        </h3>
                    </a>
                    <div class="flex items-end justify-between mt-4">
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-400 line-through">${{
                                producto.precio|default:0|add:200|floatformat:2 }}</span>
                            <span class="text-xl font-bold text-brand-dark dark:text-white">${{
                                producto.precio|default:0|floatformat:2 }}</span>
                        </div>
                        <div class="text-yellow-400 text-xs">
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-regular fa-star"></i>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full py-20 text-center">
                <i class="fa-solid fa-box-open text-6xl text-gray-200 mb-4"></i>
                <p class="text-gray-500 text-lg">No hay productos disponibles en este momento.</p>
            </div>
            {% endfor %}
        </div>

        <!-- Paginación -->
        {% if productos.has_other_pages %}
        <div class="mt-16 flex justify-center gap-2">
            {% if productos.has_previous %}
            <a href="?page={{ productos.previous_page_number }}{% if request.GET.categoria %}&categoria={{ request.GET.categoria }}{% endif %}"
                class="w-10 h-10 flex items-center justify-center rounded-full bg-white border border-gray-200 text-gray-600 hover:border-brand-gold hover:text-brand-gold transition-colors">
                <i class="fa-solid fa-chevron-left"></i>
            </a>
            {% endif %}

            {% for i in productos.paginator.page_range %}
            {% if productos.number == i %}
            <span
                class="w-10 h-10 flex items-center justify-center rounded-full bg-brand-dark text-white font-bold cursor-default">{{
                i }}</span>
            {% else %}
            <a href="?page={{ i }}{% if request.GET.categoria %}&categoria={{ request.GET.categoria }}{% endif %}"
                class="w-10 h-10 flex items-center justify-center rounded-full bg-white border border-gray-200 text-gray-600 hover:border-brand-gold hover:text-brand-gold transition-colors">{{
                i }}</a>
            {% endif %}
            {% endfor %}

            {% if productos.has_next %}
            <a href="?page={{ productos.next_page_number }}{% if request.GET.categoria %}&categoria={{ request.GET.categoria }}{% endif %}"
                class="w-10 h-10 flex items-center justify-center rounded-full bg-white border border-gray-200 text-gray-600 hover:border-brand-gold hover:text-brand-gold transition-colors">
                <i class="fa-solid fa-chevron-right"></i>
            </a>
            {% endif %}
        </div>
        {% endif %}

    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btns = document.querySelectorAll('.add-to-cart-btn');
        btns.forEach(btn => {
            btn.addEventListener('click', async () => {
                const productoId = btn.dataset.id;
                const originalContent = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                try {
                    const response = await fetch('/api/carrito/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ producto_id: productoId, cantidad: 1 })
                    });
                    const data = await response.json();
                    if (data.exito) {
                        btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                        btn.classList.add('bg-green-600', 'text-white');
                        setTimeout(() => {
                            btn.innerHTML = originalContent;
                            btn.classList.remove('bg-green-600', 'text-white');
                            btn.disabled = false;
                        }, 2000);
                    } else {
                        alert('Error: ' + data.error);
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                    }
                } catch (error) {
                    console.error(error);
                    alert('Error de conexión');
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                }
            });
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
<!--
EJEMPLO DE FORMULARIO DE PAGO CON STRIPE.JS

Este archivo muestra c√≥mo integrar Stripe.js en tu frontend para
completar pagos de forma segura.

INSTRUCCIONES:
==============
1. Reemplaza 'YOUR_PUBLISHABLE_KEY' con tu pk_test_... de Stripe
2. Aseg√∫rate que tu backend est√° en http://localhost:8000
3. El usuario debe estar autenticado (tener un access_token)
4. Copia este archivo a una nueva ruta en templates/
5. Crea una vista Django que renderice este template

FLUJO DE PAGO:
==============
1. Usuario ve el formulario de pago
2. Usuario ingresa su tarjeta
3. Se crea un PaymentIntent en el backend
4. Se confirma el pago con Stripe.js
5. El webhook actualiza el estado en la BD
-->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Pago - Stripe</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .payment-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 100%;
            padding: 40px;
        }
        
        .payment-container h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .order-summary {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 4px;
        }
        
        .order-summary p {
            margin: 8px 0;
            color: #555;
            font-size: 14px;
        }
        
        .order-summary strong {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Estilos para Stripe Elements */
        .stripe-element {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        .stripe-element--focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .stripe-element--invalid {
            border-color: #dc3545;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-row.full {
            grid-template-columns: 1fr;
        }
        
        button[type="submit"] {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 20px;
        }
        
        button[type="submit"]:hover:not(:disabled) {
            background: #5568d3;
        }
        
        button[type="submit"]:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid #c3e6cb;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            font-weight: 600;
        }
        
        .loading.active {
            display: block;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2088cc;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 13px;
            color: #004085;
        }
        
        .info-box strong {
            color: #002752;
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <h1>üí≥ Completa tu Pago</h1>
        
        <div class="info-box">
            <strong>üß™ Modo Testing:</strong><br>
            Tarjeta de prueba: <strong>4242 4242 4242 4242</strong><br>
            Fecha: Cualquier futura | CVC: Cualquier 3 d√≠gitos
        </div>
        
        <div id="successMessage" class="success-message">
            ‚úÖ ¬°Pago completado exitosamente! Tu pedido ha sido procesado.
        </div>
        
        <div class="order-summary">
            <p><strong>Pedido:</strong> <span id="orderNumber">PED-001</span></p>
            <p><strong>Monto:</strong> <span id="orderAmount">$0.00</span></p>
            <p><strong>Estado:</strong> <span id="orderStatus">Pendiente de pago</span></p>
        </div>
        
        <form id="paymentForm">
            <div class="form-group form-row full">
                <label for="customerEmail">Email</label>
                <input 
                    type="email" 
                    id="customerEmail" 
                    name="email"
                    placeholder="cliente@example.com"
                    required
                >
                <div class="error-message" id="emailError"></div>
            </div>
            
            <div class="form-group form-row full">
                <label for="customerName">Nombre Completo</label>
                <input 
                    type="text" 
                    id="customerName" 
                    name="name"
                    placeholder="Juan P√©rez"
                    required
                >
                <div class="error-message" id="nameError"></div>
            </div>
            
            <div class="form-group form-row full">
                <label for="cardElement">Informaci√≥n de la Tarjeta</label>
                <div id="cardElement" class="stripe-element"></div>
                <div class="error-message" id="cardError"></div>
            </div>
            
            <div class="loading" id="loadingSpinner">
                ‚è≥ Procesando tu pago...
            </div>
            
            <button type="submit" id="submitBtn">
                Pagar $<span id="totalAmount">0.00</span>
            </button>
        </form>
    </div>

    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <script>
        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        
        // Reemplaza con tu PUBLIC KEY de Stripe (pk_test_...)
        const STRIPE_PUBLIC_KEY = 'YOUR_PUBLISHABLE_KEY';
        
        // URL del backend
        const API_BASE_URL = 'http://localhost:8000/api';
        
        // Datos del pedido (cambiar seg√∫n sea necesario)
        const ORDER_DATA = {
            pedido_id: 1,  // Cambiar al ID del pedido real
            numero_pedido: 'PED-001',
            monto: 99.99
        };
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        
        const stripe = Stripe(STRIPE_PUBLIC_KEY);
        const elements = stripe.elements();
        const cardElement = elements.create('card');
        
        let accessToken = null;
        
        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================
        
        /**
         * Obtener el access token del localStorage
         * (El usuario debe estar autenticado)
         */
        function getAccessToken() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                showError('cardError', 'Debes estar autenticado para realizar un pago. Por favor, inicia sesi√≥n.');
                return null;
            }
            return token;
        }
        
        /**
         * Mostrar un mensaje de error
         */
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }
        
        /**
         * Limpiar mensajes de error
         */
        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.textContent = '';
                el.style.display = 'none';
            });
        }
        
        /**
         * Mostrar/ocultar animaci√≥n de carga
         */
        function setLoading(isLoading) {
            const spinner = document.getElementById('loadingSpinner');
            const btn = document.getElementById('submitBtn');
            
            if (isLoading) {
                spinner.classList.add('active');
                btn.disabled = true;
            } else {
                spinner.classList.remove('active');
                btn.disabled = false;
            }
        }
        
        /**
         * Crear un PaymentIntent en el backend
         */
        async function createPaymentIntent() {
            accessToken = getAccessToken();
            if (!accessToken) return null;
            
            const email = document.getElementById('customerEmail').value;
            const name = document.getElementById('customerName').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/pago/crear/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pedido_id: ORDER_DATA.pedido_id,
                        email: email,
                        nombre: name
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Error creando el pago');
                }
                
                const data = await response.json();
                return data;
                
            } catch (error) {
                showError('cardError', `Error: ${error.message}`);
                return null;
            }
        }
        
        /**
         * Confirmar el pago con Stripe
         */
        async function confirmPayment(clientSecret) {
            try {
                const { paymentIntent, error } = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            name: document.getElementById('customerName').value,
                            email: document.getElementById('customerEmail').value
                        }
                    }
                });
                
                if (error) {
                    showError('cardError', error.message);
                    return false;
                }
                
                return paymentIntent;
                
            } catch (error) {
                showError('cardError', `Error: ${error.message}`);
                return false;
            }
        }
        
        /**
         * Mostrar mensaje de √©xito
         */
        function showSuccess() {
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('paymentForm').style.display = 'none';
            
            // Redirigir despu√©s de 3 segundos
            setTimeout(() => {
                window.location.href = '/pedidos/';
            }, 3000);
        }
        
        // ============================================
        // MONTAJE DEL COMPONENTE
        // ============================================
        
        // Montar Card Element
        cardElement.mount('#cardElement');
        
        // Eventos de validaci√≥n
        cardElement.addEventListener('change', function(event) {
            const displayError = document.getElementById('cardError');
            if (event.error) {
                showError('cardError', event.error.message);
            } else {
                clearErrors();
            }
        });
        
        // Actualizar datos del pedido en la UI
        document.getElementById('orderNumber').textContent = ORDER_DATA.numero_pedido;
        document.getElementById('orderAmount').textContent = `$${ORDER_DATA.monto.toFixed(2)}`;
        document.getElementById('totalAmount').textContent = ORDER_DATA.monto.toFixed(2);
        
        // ============================================
        // MANEJADOR DEL FORMULARIO
        // ============================================
        
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            setLoading(true);
            clearErrors();
            
            // Validar datos
            const email = document.getElementById('customerEmail').value;
            const name = document.getElementById('customerName').value;
            
            if (!email || !name) {
                showError('nameError', 'Por favor completa todos los campos');
                setLoading(false);
                return;
            }
            
            // Crear PaymentIntent
            const paymentData = await createPaymentIntent();
            if (!paymentData) {
                setLoading(false);
                return;
            }
            
            // Confirmar pago
            const paymentIntent = await confirmPayment(paymentData.client_secret);
            
            if (paymentIntent && paymentIntent.status === 'succeeded') {
                showSuccess();
            } else if (paymentIntent && paymentIntent.status === 'requires_action') {
                showError('cardError', 'Se requiere autenticaci√≥n adicional. Por favor intenta de nuevo.');
            }
            
            setLoading(false);
        });
        
        // ============================================
        // CARGAR DATOS DEL PEDIDO EN P√ÅGINA CARGA
        // ============================================
        
        // En una aplicaci√≥n real, estos datos vendr√≠an del servidor
        // mediante una petici√≥n GET /api/pedidos/{id}/
        
        window.addEventListener('load', () => {
            // Obtener access token del localStorage
            const token = localStorage.getItem('access_token');
            if (!token) {
                showError('cardError', 'No est√°s autenticado. Inicia sesi√≥n para continuar.');
                document.getElementById('submitBtn').disabled = true;
            }
        });
    </script>
</body>
</html>
